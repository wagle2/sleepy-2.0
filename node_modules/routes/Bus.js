/*명령어 모듈 적용법
첫줄은 var moduleNmae = function(r,args) (moduleName은 파일명과 같음) 로 시작해야함.
마지막줄은 moduleName으로 끝나야함.
최종적으로 출력될 결과물인 this.final 이 존재해야함.
*/
var Bus = function(r){
    this.final = null;
    I.register("busSelect"+r.sender,r.room,r.sender,function(input){
        info = 광주버스정류장이름찾기(r);
            var busstopInfo = new Object();
            /* 
             *   busstopInfo.Id = "";
             *   busstopInfo.Name0 = "";
             *   busstopInfo.NEXT_BUSSTOP0 = "";
             *   busstopInfo.Name1 = "";
             *   busstopInfo.NEXT_BUSSTOP1 = "";
             *   busstopInfo.length = 0;
             */

        //r.replier.reply(info.length);
        if (info.length == 1){
            r.msg = " "+ info.Name0;
            //r.replier.reply(info.Id+" "+info.NEXT_BUSSTOP0);
            버스현재위치(r,info.Id,info.NEXT_BUSSTOP0);
        } else if(info.length == 2){
            r.replier.reply("조회하실 방향을 선택해주세요.");
            msg1=input.getMsg();
            if(msg1 == "1"){
                r.msg = " "+ info.Name0;
                버스현재위치(r,info.Id,info.NEXT_BUSSTOP0);
            } else if(msg1 == "2"){
                r.msg = " "+ info.Name1;
                버스현재위치(r,info.Id,info.NEXT_BUSSTOP1);
            } else{
                r.replier("제대로 입력해주세요.");
            }
        }
    })
}



function 버스현재위치(r,busStopName,next_busStopName){
    busstopId = r.msg.split(" ")[1];
    busstopInfo = org.jsoup.Jsoup.connect("http://api.gwangju.go.kr/json/arriveInfo?ServiceKey=BknKnKlcOt5e3xllE%2Fboca5kw2Dzmqwm2lNf7XEmAporlHM7JPggxLbS8GgtoSO6%2FcLjBJKOgOMSH6Bmt4EUlw%3D%3D&serviceKey=&BUSSTOP_ID="+busstopId).get()
    busstopInfoJson = JSON.parse(busstopInfo.select("body").text());
    result=busStopName +
    　　"⇒"+next_busStopName+"\n------------------------------------\n"
    busNum = busstopInfoJson.BUSSTOP_LIST.length;
    for(i=0;i<busNum;i++){
        result += (busstopInfoJson.BUSSTOP_LIST[i].LINE_NAME.toString() + "  ("+ busstopInfoJson.BUSSTOP_LIST[i].REMAIN_MIN.toString() + "분) (" + busstopInfoJson.BUSSTOP_LIST[i].BUSSTOP_NAME.toString()  + ")\n")
    }
    r.replier.reply(result.trim());
    //trim은 문자의 양끝 공백 제거
}


function 광주버스정류장받아오기(r){
    var url = "http://api.gwangju.go.kr/json/stationInfo?ServiceKey=BknKnKlcOt5e3xllE%2Fboca5kw2Dzmqwm2lNf7XEmAporlHM7JPggxLbS8GgtoSO6%2FcLjBJKOgOMSH6Bmt4EUlw%3D%3D&serviceKey="
    var busstopName = org.jsoup.Jsoup.connect(url).get()
    var bis = JSON.parse(busstopName.select("body").text()).fSTATION_LIST;
    File.save("/sdcard/test.json",JSON.stringify(bis));
    r.replier.reply("버스정류장 로딩완료!")
    //STATION_NUM,BUSSTOP_NAME,ARS_ID,NEXT_BUSSTOP,BUSSTOP_ID,LONGITUDE,NAME_E,LATITUDE
}

function 광주버스정류장이름찾기(r){
    var busstopInfo = new Object();
    busstopInfo.Id = "";
    busstopInfo.Name0 = "";
    busstopInfo.NEXT_BUSSTOP0 = "";
    busstopInfo.Name1 = "";
    busstopInfo.NEXT_BUSSTOP1 = "";
    busstopInfo.length = 0;

    try{
        busstopInfo.Id = r.msg.split(" ")[1];
        if(busstopInfo.Id=="일사"){busstopInfo.Id = "일곡사거리"};
        if(busstopInfo.Id=="북경"){busstopInfo.Id = "북부경찰서"};
        if(busstopInfo.Id=="삼호"){busstopInfo.Id = "일곡삼호아파트"};
        if(busstopInfo.Id=="삼익"){busstopInfo.Id = "매곡삼익아파트"};
        if(busstopInfo.Id=="김머중"||busstopInfo.Id=="김대중"||busstopInfo.Id=="김머중권벤션센터"||busstopInfo.Id=="김머중컨벤션센터"||busstopInfo.Id=="머중이권벤션센터"||busstopInfo.Id=="머중이"){busstopInfo.Id = "김대중컨벤션센터"};

        busstopInfo.length = bis.filter(v=>v.BUSSTOP_NAME==busstopInfo.Id).length;
        
        if (busstopInfo.length == 1){
            busstopInfo.Name0 = bis.filter(v=>v.BUSSTOP_NAME==busstopInfo.Id)[0].BUSSTOP_ID;
            busstopInfo.NEXT_BUSSTOP0 = bis.filter(v=>v.BUSSTOP_NAME==busstopInfo.Id)[0].NEXT_BUSSTOP;
        }else if(busstopInfo.length ==2){
            busstopInfo.Name0 = bis.filter(v=>v.BUSSTOP_NAME==busstopInfo.Id)[0].BUSSTOP_ID;
            busstopInfo.NEXT_BUSSTOP0 = bis.filter(v=>v.BUSSTOP_NAME==busstopInfo.Id)[0].NEXT_BUSSTOP;
            busstopInfo.Name1 = bis.filter(v=>v.BUSSTOP_NAME==busstopInfo.Id)[1].BUSSTOP_ID;
            busstopInfo.NEXT_BUSSTOP1 = bis.filter(v=>v.BUSSTOP_NAME==busstopInfo.Id)[1].NEXT_BUSSTOP;
        }

        //include를 사용해도 됨  v.includes("석산") 이런식으로
  
        if(busstopInfo.length == 1){
            test="          [버스정보알림]\n------------------------------------\n"
            r.replier.reply("["+busstopInfo.Id+"]\n[1] "+ busstopInfo.NEXT_BUSSTOP0 +"방향 : " + busstopInfo.Name0);
            return busstopInfo;
        }else if(busstopInfo.length == 2){
            r.replier.reply("["+busstopInfo.Id+"]\n[1] "+ busstopInfo.NEXT_BUSSTOP0 +"방향 : " + busstopInfo.Name0 + "\n[2] " + busstopInfo.NEXT_BUSSTOP1 +"방향 : " + busstopInfo.Name1);
            return busstopInfo;
        }
        else{
            r.replier.reply("정류장명을 다시 확인해주세요zzZ");
            return busstopInfo;
        }
    } catch (e) {
        r.replier.reply("정류장명을 다시 확인해주세요zzZ\n"+e);
    }
        //r.replier.reply("["+busstopId+"]\n"+ next_busstopName0 +"방향 : " + busstopName0);
}
Bus